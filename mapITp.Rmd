---
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(leaflet)
library(curl)
library(jsonlite)
library(magrittr)
library(tibble)
library(dplyr)
library(shiny)
library(ggplot2)
library(gganimate)
library(viridis)
library(leaflet.minicharts)
titletext <- paste0("Data Source:COVID19 github rep Umberto Rosini.<br />  Date : ", Sys.Date(), "<br /> Created with: R by J. Mayr")
pal <- colorNumeric("viridis", NULL)
temp = tempfile(fileext = ".xlsx")
tilesURL <- rgdal::readOGR("https://raw.githubusercontent.com/openpolis/geojson-italy/master/geojson/limits_IT_provinces.geojson")
dataURL<- 'https://github.com/MatteoHenryChinaski/Comuni-Italiani-2018-Sql-Json-excel/blob/master/italy_provincies.xlsx?raw=true'
download.file(dataURL, destfile=temp, mode='wb')
dfprov <- readxl::read_excel(temp, sheet =2)
dfprov <- filter(dfprov, dfprov$id_regione %in% 1:20)
#dfprov <- dfprov %>%  rename( reg_istat_code = cod_istat)
#dfprov <- dfprov %>%  rename( codice_regione = id_regione)
#dfprov$codice_regione <- sprintf("%02d",as.numeric(dfprov$codice_regione))
ev <- select(dfprov, c("sigla","provincia","residenti","id_regione"))
pcmdpcfr <- read.csv(curl("https://raw.githubusercontent.com/pcm-dpc/COVID-19/master/dati-province/dpc-covid19-ita-province-latest.csv"),na.strings=c("NaN", " "))
pcmdpcr <- filter(pcmdpcfr,pcmdpcfr$lat > 0 & pcmdpcfr$long >0)
pcmdpcr$data <- as.Date(as.factor(gsub("T.*","",pcmdpcr$data)))
ev <- ev %>%  rename(sigla_provincia = sigla)
testorder <- data.frame()
testorder <- as.data.frame(as.character(tilesURL@data[["prov_acr"]]))
names(testorder) <- "sigla_provincia"
ev <- full_join(testorder,ev,  by = "sigla_provincia")
# pcmdpcr<- pcmdpcr%>% select(reg_istat_code, totale_positivi,isolamento_domiciliare,variazione_totale_positivi,dimessi_guariti,deceduti)%>% group_by(reg_istat_code) %>% summarise_all(sum)
pcmdpcr <-full_join(ev, pcmdpcr,  by = "sigla_provincia")
```
`r titletext`

In die Karte klicken um die Daten zu sehen! 
```{r,echo=FALSE,out.width="100%"}
leaflet(tilesURL) %>% 
  addProviderTiles(providers$Esri.WorldImagery, group = "World Imagery") %>%
  addProviderTiles(providers$CartoDB.Positron)%>%
  addLayersControl(baseGroups = c("Carto DB Positron", "World Imagery")) %>%
  addPolygons(stroke = F,fillOpacity = .7,fillColor = ~pal(pcmdpcr$totale_casi/pcmdpcr$residenti*100),labelOptions = labelOptions(textsize = "15px",opacity = 0.7),label = lapply(paste0("<b>",pcmdpcr$provincia,"</b> <br />  in Positive in %: ",formatC( pcmdpcr$totale_casi/pcmdpcr$residenti*100),"<br />  FÃ¤lle: ",pcmdpcr$totale_casi ), htmltools::HTML))%>%
  addLegend(pal = pal,title = "Positive in % zur EZ",labFormat = labelFormat(),na.label = "Keine Angabe",position = "bottomright", values = ~pcmdpcr$totale_casi/pcmdpcr$residenti*100, opacity = .7)

```